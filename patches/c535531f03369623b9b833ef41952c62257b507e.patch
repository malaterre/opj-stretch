From c535531f03369623b9b833ef41952c62257b507e Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Wed, 16 Aug 2017 17:20:29 +0200
Subject: [PATCH] opj_t2_encode_packet(): fix potential write heap buffer
 overflow (#992)

---
 src/lib/openjp2/j2k.c |  7 ++++++-
 src/lib/openjp2/t2.c  | 18 ++++++++++++++++++
 2 files changed, 24 insertions(+), 1 deletion(-)

--- a/src/lib/openjp2/j2k.c
+++ b/src/lib/openjp2/j2k.c
@@ -4309,6 +4309,12 @@
         assert(p_manager != 00);
         assert(p_stream != 00);
 
+    if (p_total_data_size < 4) {
+        opj_event_msg(p_manager, EVT_ERROR,
+                      "Not enough bytes in output buffer to write SOD marker\n");
+        return OPJ_FALSE;
+    }
+
         opj_write_bytes(p_data,J2K_MS_SOD,2);                                   /* SOD */
         p_data += 2;
 
